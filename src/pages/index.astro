---
import Layout from "../layouts/Layout.astro";
import Calendar from "../components/Calendar.astro";
import { getEvents, getParticipants } from "../lib/db";

const user = Astro.locals.user;

const url = new URL(Astro.request.url);
const currentYear = url.searchParams.get("year")
	? parseInt(url.searchParams.get("year")!)
	: new Date().getFullYear();
const currentMonth = url.searchParams.get("month")
	? parseInt(url.searchParams.get("month")!)
	: new Date().getMonth();

const events = await getEvents();
const participants = await getParticipants();

// Enrich events with participant counts for view
const eventsWithCount = events.map((e) => ({
	...e,
	participantsCount: participants.filter((p) => p.eventId === e.id).length,
}));
---

<Layout title="Calendario Condiviso">
	<div
		class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3"
	>
		<div>
			<h1 class="display-6 mb-0">Eventi Compagnia</h1>
		</div>
		<div class="d-flex flex-wrap align-items-center gap-3">
			<div
				class="btn-group shadow-sm"
				role="group"
				aria-label="Visualizzazione"
			>
				<a href="/" class="btn btn-primary active">
					<i class="bi bi-calendar3"></i>
					<span class="d-none d-sm-inline">Calendario</span>
				</a>
				<a href="/upcoming" class="btn btn-outline-primary">
					<i class="bi bi-list-ul"></i>
					<span class="d-none d-sm-inline">Lista</span>
				</a>
			</div>

			{
				user ? (
					<button
						class="btn btn-success"
						data-bs-toggle="modal"
						data-bs-target="#createEventModal"
					>
						<i class="bi bi-plus-lg" /> Crea Evento
					</button>
				) : (
					<div class="alert alert-warning py-2 px-3 d-inline-block mb-0 small">
						Accedi per creare eventi
					</div>
				)
			}
		</div>
	</div>

	<Calendar
		year={currentYear}
		month={currentMonth}
		events={eventsWithCount}
	/>

	<!-- Create Event Modal -->
	<div
		class="modal fade"
		id="createEventModal"
		tabindex="-1"
		aria-labelledby="createEventModalLabel"
		aria-hidden="true"
	>
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="createEventModalLabel">
						Nuovo Evento
					</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="create-event-form">
						<div class="mb-3">
							<label for="eventTitle" class="form-label"
								>Titolo</label
							>
							<input
								type="text"
								class="form-control"
								id="eventTitle"
								required
							/>
						</div>
						<div class="mb-3">
							<label for="eventLocation" class="form-label"
								>Luogo</label
							>
							<input
								type="text"
								class="form-control"
								id="eventLocation"
								placeholder="Es: Sede sociale, Online, ecc."
							/>
						</div>
						<div class="mb-3">
							<label class="form-label">Descrizione</label>
							<div id="eventDescEditor"></div>
						</div>
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="eventDate" class="form-label"
									>Data</label
								>
								<input
									type="date"
									class="form-control"
									id="eventDate"
									required
								/>
							</div>
							<div class="col-md-6 mb-3">
								<label for="eventTime" class="form-label"
									>Ora</label
								>
								<input
									type="time"
									class="form-control"
									id="eventTime"
									required
								/>
							</div>
						</div>
						<div class="d-grid gap-2">
							<button type="submit" class="btn btn-primary"
								>Salva Evento</button
							>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<!-- Event Detail Modal -->
	<div
		class="modal fade"
		id="eventDetailModal"
		tabindex="-1"
		aria-labelledby="eventDetailLabel"
		aria-hidden="true"
	>
		<div class="modal-dialog modal-lg">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="detailTitle">
						Dettagli Evento
					</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-12">
							<div
								id="detailDesc"
								class="mb-3 bg-light p-3 rounded"
								style="min-height: 50px; color: #333;"
							>
							</div>
							<ul class="list-unstyled">
								<li>
									<strong>Data:</strong>
									<span id="detailDate"></span>
								</li>
								<li>
									<strong>Ora:</strong>
									<span id="detailTime"></span>
								</li>
								<li>
									<strong>Luogo:</strong>
									<span
										id="detailLocation"
										class="text-primary fw-bold"></span>
								</li>
							</ul>
							{
								user && (
									<div class="mt-4 pt-3 border-top d-flex gap-2">
										<button
											id="editBtn"
											class="btn btn-primary btn-sm d-none"
										>
											<i class="bi bi-pencil-square" />{" "}
											Modifica
										</button>
										<button
											id="deleteBtn"
											class="btn btn-danger btn-sm d-none"
										>
											<i class="bi bi-trash" /> Elimina
										</button>
									</div>
								)
							}
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Edit Event Modal -->
	<div
		class="modal fade"
		id="editEventModal"
		tabindex="-1"
		aria-labelledby="editEventModalLabel"
		aria-hidden="true"
	>
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="editEventModalLabel">
						Modifica Evento
					</h5>
					<button
						type="button"
						class="btn-close"
						data-bs-dismiss="modal"
						aria-label="Close"></button>
				</div>
				<div class="modal-body">
					<form id="edit-event-form">
						<div class="mb-3">
							<label for="editEventTitle" class="form-label"
								>Titolo</label
							>
							<input
								type="text"
								class="form-control"
								id="editEventTitle"
								required
							/>
						</div>
						<div class="mb-3">
							<label for="editEventLocation" class="form-label"
								>Luogo</label
							>
							<input
								type="text"
								class="form-control"
								id="editEventLocation"
							/>
						</div>
						<div class="mb-3">
							<label class="form-label">Descrizione</label>
							<div id="editEventDescEditor"></div>
						</div>
						<div class="row">
							<div class="col-md-6 mb-3">
								<label for="editEventDate" class="form-label"
									>Data</label
								>
								<input
									type="date"
									class="form-control"
									id="editEventDate"
									required
								/>
							</div>
							<div class="col-md-6 mb-3">
								<label for="editEventTime" class="form-label"
									>Ora</label
								>
								<input
									type="time"
									class="form-control"
									id="editEventTime"
									required
								/>
							</div>
						</div>
						<div class="d-grid gap-2">
							<button type="submit" class="btn btn-primary"
								>Aggiorna Evento</button
							>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>

	<script>
		import { Modal } from "bootstrap";
		declare var Quill: any;

		// Initialize Quill editors
		const quillConfig = {
			theme: "snow",
			modules: {
				toolbar: [
					["bold", "italic", "strike"],
					["link", "blockquote", "code-block"],
					[{ list: "ordered" }, { list: "bullet" }],
					["clean"],
				],
			},
		};

		let createQuill: any;
		let editQuill: any;

		document.addEventListener("DOMContentLoaded", () => {
			const createEditorEl = document.getElementById("eventDescEditor");
			if (createEditorEl) {
				createQuill = new Quill("#eventDescEditor", quillConfig);
			}
			const editEditorEl = document.getElementById("editEventDescEditor");
			if (editEditorEl) {
				editQuill = new Quill("#editEventDescEditor", quillConfig);
			}
		});

		// Auto-open create modal if query param exists
		const urlParams = new URLSearchParams(window.location.search);
		if (urlParams.get("create") === "true") {
			const createModalEl = document.getElementById("createEventModal");
			if (createModalEl) {
				const createModal = new Modal(createModalEl);
				createModal.show();
				// Clean URL
				window.history.replaceState(
					{},
					document.title,
					window.location.pathname,
				);
			}
		}

		// Handle Create Event
		const createForm = document.getElementById("create-event-form");
		if (createForm) {
			createForm.addEventListener("submit", async (e) => {
				e.preventDefault();
				const title = (
					document.getElementById("eventTitle") as HTMLInputElement
				).value;
				const description = createQuill
					? createQuill.root.innerHTML
					: "";
				const location = (
					document.getElementById("eventLocation") as HTMLInputElement
				).value;
				const date = (
					document.getElementById("eventDate") as HTMLInputElement
				).value;
				const time = (
					document.getElementById("eventTime") as HTMLInputElement
				).value;

				try {
					const res = await fetch("/api/events", {
						method: "POST",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							title,
							description,
							location,
							date,
							time,
						}),
					});

					if (res.ok) {
						window.location.reload();
					} else {
						const data = await res.json();
						alert(data.error || "Errore creazione evento");
					}
				} catch (error) {
					console.error(error);
					alert("Errore di rete");
				}
			});
		}

		// Handle Event Details Modal Check
		// We attach click listeners to calendar events via event delegation or direct if easy.
		// Since Calendar renders server-side, we can just grab all `.event-badge`.

		const eventBadges = document.querySelectorAll(".event-badge");
		const detailModalEl = document.getElementById("eventDetailModal");
		const detailModal = new Modal(detailModalEl as HTMLElement);
		let currentEventId: string | null = null;

		eventBadges.forEach((badge) => {
			badge.addEventListener("click", async (e) => {
				e.preventDefault();
				const id = badge.getAttribute("data-id");
				if (!id) return;

				// Fetch details
				try {
					const res = await fetch(`/api/events/${id}`);
					if (!res.ok) return;
					const data = await res.json();

					// Populate modal
					document.getElementById("detailTitle")!.textContent =
						data.title;
					document.getElementById("detailDesc")!.innerHTML =
						data.description || "<i>Nessuna descrizione.</i>";
					document.getElementById("detailDate")!.textContent =
						new Date(data.date).toLocaleDateString("it-IT");
					document.getElementById("detailTime")!.textContent =
						data.time;
					document.getElementById("detailLocation")!.textContent =
						data.location || "Non specificato";

					// Logic for buttons
					currentEventId = id;
					const deleteBtn = document.getElementById("deleteBtn");
					const editBtn = document.getElementById("editBtn");

					// Check if user is creator or admin
					const meRes = await fetch("/api/auth/me");
					if (meRes.ok) {
						const me = await meRes.json();
						const canManage =
							me.id === data.creatorId || me.isAdmin;

						if (deleteBtn) {
							if (canManage) {
								deleteBtn.classList.remove("d-none");
							} else {
								deleteBtn.classList.add("d-none");
							}
						}
						if (editBtn) {
							if (canManage) {
								editBtn.classList.remove("d-none");
							} else {
								editBtn.classList.add("d-none");
							}
						}

						// Store current data for editing
						(badge as any)._eventData = data;
					} else {
						if (deleteBtn) deleteBtn.classList.add("d-none");
						if (editBtn) editBtn.classList.add("d-none");
					}

					detailModal.show();
				} catch (error) {
					console.error(error);
				}
			});
		});

		// Handle Edit Button Click
		const editBtn = document.getElementById("editBtn");
		const editModalEl = document.getElementById("editEventModal");
		const editModal = new Modal(editModalEl as HTMLElement);

		if (editBtn) {
			editBtn.addEventListener("click", async () => {
				if (!currentEventId) return;

				try {
					// Fetch data again to be sure (consistent with upcoming view)
					const res = await fetch(`/api/events/${currentEventId}`);
					if (!res.ok) return;
					const data = await res.json();

					(
						document.getElementById(
							"editEventTitle",
						) as HTMLInputElement
					).value = data.title;

					if (editQuill) {
						editQuill.root.innerHTML = data.description || "";
					}
					(
						document.getElementById(
							"editEventDate",
						) as HTMLInputElement
					).value = data.date; // Uses ISO format from DB
					(
						document.getElementById(
							"editEventLocation",
						) as HTMLInputElement
					).value = data.location || "";
					(
						document.getElementById(
							"editEventTime",
						) as HTMLInputElement
					).value = data.time;

					detailModal.hide();
					// Wait a tiny bit for transition if needed, but show() should handle it
					editModal.show();
				} catch (e) {
					console.error("Error loading edit data:", e);
				}
			});
		}

		// Handle Edit Submit
		const editForm = document.getElementById("edit-event-form");
		if (editForm) {
			editForm.addEventListener("submit", async (e) => {
				e.preventDefault();
				if (!currentEventId) return;

				const title = (
					document.getElementById(
						"editEventTitle",
					) as HTMLInputElement
				).value;
				const description = editQuill ? editQuill.root.innerHTML : "";
				const location = (
					document.getElementById(
						"editEventLocation",
					) as HTMLInputElement
				).value;
				const date = (
					document.getElementById("editEventDate") as HTMLInputElement
				).value;
				const time = (
					document.getElementById("editEventTime") as HTMLInputElement
				).value;

				try {
					const res = await fetch(`/api/events/${currentEventId}`, {
						method: "PATCH",
						headers: { "Content-Type": "application/json" },
						body: JSON.stringify({
							title,
							description,
							location,
							date,
							time,
						}),
					});

					if (res.ok) {
						window.location.reload();
					} else {
						const data = await res.json();
						alert(data.error || "Errore aggiornamento evento");
					}
				} catch (error) {
					console.error(error);
					alert("Errore di rete");
				}
			});
		}

		// Handle Delete
		const deleteBtn = document.getElementById("deleteBtn");
		if (deleteBtn) {
			deleteBtn.addEventListener("click", async () => {
				if (
					!currentEventId ||
					!confirm("Sei sicuro di voler eliminare questo evento?")
				)
					return;
				try {
					const res = await fetch(`/api/events/${currentEventId}`, {
						method: "DELETE",
					});
					if (res.ok) {
						alert("Evento eliminato");
						window.location.reload();
					} else {
						alert("Errore eliminazione");
					}
				} catch (e) {
					console.error(e);
				}
			});
		}
	</script>
</Layout>
